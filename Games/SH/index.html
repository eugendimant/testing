<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crimson Corridor 2D: Serbianhero at Nachtarena</title>
  <meta name="description" content="2D top-down action mini-game. Walk, talk, slap, cool off on the slide, and try to get into Nachtarena." />
  <style>
    :root{
      --bg:#05050a;
      --panel: rgba(18,18,30,0.88);
      --panel2: rgba(10,10,20,0.78);
      --line: rgba(255,255,255,0.10);
      --text: #f7f7fb;
      --muted: rgba(247,247,251,0.72);
      --hot: #ff4d6d;
      --ok: #36d399;
      --warn: #fbbf24;
      --shadow: 0 18px 44px rgba(0,0,0,0.62);
      --r: 16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html, body{ height:100%; margin:0; background: radial-gradient(circle at top, #15152a, var(--bg) 60%); color: var(--text); font-family: var(--font); }
    .wrap{ max-width: 1180px; margin: 0 auto; padding: 16px 14px 24px; }
    .top{ display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; margin-bottom: 10px; flex-wrap:wrap; }
    .top h1{ margin:0; font-size: 18px; letter-spacing: 0.12em; text-transform: uppercase; }
    .top .sub{ color: var(--muted); font-size: 12px; margin-top: 6px; }
    .grid{ display:grid; grid-template-columns: 2.3fr 1fr; gap: 14px; align-items:start; }
    .card{ background: var(--panel); border: 1px solid var(--line); border-radius: var(--r); box-shadow: var(--shadow); overflow:hidden; }
    .card.pad{ padding: 12px 12px; }
    #game{ width:100%; aspect-ratio: 16/9; background: #000; display:block; }
    .hud h2, .log h2{ margin:0 0 8px 0; font-size: 14px; letter-spacing: 0.04em; }
    .pill{ display:flex; align-items:center; justify-content:space-between; gap:10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.07); border-radius: 999px; padding: 7px 10px; font-size: 12px; margin: 7px 0; }
    .pill b{ font-size: 12px; }
    .pill .v{ font-variant-numeric: tabular-nums; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.06); }
    .row{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 10px; }
    .btn{ appearance:none; border:0; cursor:pointer; border-radius: 12px; padding: 10px 12px; font-weight: 800; color: #fff;
      background: linear-gradient(90deg, #e94560, #ff4d6d); box-shadow: 0 10px 26px rgba(233,69,96,0.28);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.alt{ background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10); box-shadow:none; font-weight:700; }
    .btn.good{ background: linear-gradient(90deg, #1dd1a1, #36d399); box-shadow: 0 10px 26px rgba(54,211,153,0.22); }
    .btn.warn{ background: linear-gradient(90deg, #f59e0b, #fbbf24); box-shadow: 0 10px 26px rgba(251,191,36,0.18); color:#0b0b10; }
    .note{ background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px 12px; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .log .entry{ background: var(--panel2); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 9px 10px; margin-bottom: 8px; font-size: 12px; color: var(--text); line-height: 1.35; }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10); font-size: 12px; color: var(--muted); }
    .footer{ margin-top: 12px; color: var(--muted); font-size: 12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .btn{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Crimson Corridor 2D: Serbianhero at Nachtarena</h1>
        <div class="sub">Move, interact, slap (cartoon), cool off on the neon slide, and beat the door.</div>
      </div>
      <div class="badge" id="badge">Night 1 · Stage 0/3</div>
    </div>

    <div class="grid">
      <div class="card">
        <canvas id="game"></canvas>
      </div>

      <div>
        <div class="card pad hud">
          <h2>HUD</h2>
          <div id="hud"></div>
          <div class="row">
            <button class="btn alt" id="btnReset">Reset</button>
            <button class="btn alt" id="btnMute">Mute</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card pad log">
          <h2>Feed</h2>
          <div id="log"></div>
          <div class="note" style="margin-top:10px">
            <b>Controls</b><br/>
            Move: WASD / Arrow keys<br/>
            Interact: E<br/>
            Slap (cartoon): Space<br/>
            Pause: P<br/><br/>
            <b>Do-nots</b>: no gore, no slurs, no personal data, no ads/analytics, no monetization.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Runs fully in the browser. Static file. No tracking.</div>
      <div>Note: This is 2D, not GTA-level 3D.</div>
    </div>
  </div>

  <!-- Phaser 3 (CDN). If you need offline, download phaser.min.js and reference it locally. -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <script>
  // =========================
  // Guardrails / do-nots
  // =========================
  // This game intentionally avoids:
  // 1) gore, 2) slurs, 3) personal data collection, 4) ads/analytics, 5) monetization.

  // =========================
  // State
  // =========================
  const MAX = { swagger:100, respect:100, energy:100, cash:100, heat:100, suit:100, rage:100, viral:100 };
  const stats = { swagger:45, respect:35, energy:55, cash:40, heat:10, suit:80, rage:20, viral:5 };
  const inv = { "VIP Card": 0, "Silver Chain": 0, "Press Pass": 0 };
  const flags = { stage:0, night:1, denied:0, bouncer:"iron_wall", paused:false, muted:false };
  const log = [];
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function addLog(s){ log.push(s); renderLog(); }
  function applyDelta(d){
    for(const [k, ch] of Object.entries(d||{})){
      if(stats[k] !== undefined) stats[k] = clamp(stats[k] + ch, 0, MAX[k]);
    }
    renderHUD();
  }

  const BOUNCERS = {
    iron_wall: {
      name: "Miro 'Iron Wall'",
      checks: { min_suit: 75, min_respect: 45, min_viral: null, max_heat: 35, requires_item: null },
      tip: "He responds best to calm energy and low heat."
    },
    club_historian: {
      name: "Lana 'Records'",
      checks: { min_suit: 60, min_respect: 35, min_viral: 10, max_heat: 55, requires_item: "Silver Chain" },
      tip: "Bring the chain. Tell a heroic story. Be at least a little viral."
    },
    flash: {
      name: "Viktor 'Flash'",
      checks: { min_suit: 55, min_respect: 30, min_viral: 25, max_heat: 28, requires_item: null },
      tip: "He wants a moment that looks good on camera."
    },
    night_warden: {
      name: "Nebojsa 'Warden'",
      checks: { min_suit: 50, min_respect: 55, min_viral: null, max_heat: 22, requires_item: "VIP Card" },
      tip: "Heat-sensitive. VIP card helps."
    },
    heartbeat: {
      name: "Ana 'Heartbeat'",
      checks: { min_suit: 45, min_respect: 40, min_viral: null, max_heat: 50, requires_item: null },
      tip: "Empathy helps. Keep rage in check."
    }
  };

  function pickBouncer(){
    const keys = Object.keys(BOUNCERS);
    flags.bouncer = keys[Math.floor(Math.random()*keys.length)];
  }

  function checkDoor(){
    const b = BOUNCERS[flags.bouncer];
    const c = b.checks;
    const reasons = [];
    if(stats.suit < c.min_suit) reasons.push("Suit too scuffed");
    if(stats.respect < c.min_respect) reasons.push("Not enough respect");
    if(c.min_viral !== null && stats.viral < c.min_viral) reasons.push("Not viral enough");
    if(c.max_heat !== null && stats.heat > c.max_heat) reasons.push("Heat too high");
    if(c.requires_item && (inv[c.requires_item]||0) <= 0) reasons.push("Missing required item");
    return { ok: reasons.length === 0, reasons, bouncer:b };
  }

  function updateBadge(){
    const el = document.getElementById("badge");
    el.textContent = `Night ${flags.night} · Stage ${flags.stage}/3`;
  }

  function renderHUD(){
    const hud = document.getElementById("hud");
    function pill(k, v){
      return `<div class="pill"><b>${k}</b><span class="v">${v}</span></div>`;
    }
    hud.innerHTML = [
      pill("Swagger", stats.swagger),
      pill("Respect", stats.respect),
      pill("Energy", stats.energy),
      pill("Heat", stats.heat),
      pill("Suit", stats.suit),
      pill("Rage", stats.rage),
      pill("Viral", stats.viral),
      `<div class="note"><b>Bouncer:</b> ${BOUNCERS[flags.bouncer].name}<br/><span style="opacity:.85">${BOUNCERS[flags.bouncer].tip}</span></div>`,
      `<div class="note"><b>Inventory</b><br/>VIP Card: ${inv["VIP Card"]||0} · Silver Chain: ${inv["Silver Chain"]||0} · Press Pass: ${inv["Press Pass"]||0}</div>`
    ].join("");
    updateBadge();
  }

  function renderLog(){
    const el = document.getElementById("log");
    const last = log.slice(-7).reverse();
    el.innerHTML = last.map(x => `<div class="entry">${escapeHTML(x)}</div>`).join("");
  }

  function escapeHTML(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function resetAll(){
    stats.swagger=45; stats.respect=35; stats.energy=55; stats.cash=40;
    stats.heat=10; stats.suit=80; stats.rage=20; stats.viral=5;
    inv["VIP Card"]=0; inv["Silver Chain"]=0; inv["Press Pass"]=0;
    flags.stage=0; flags.night=1; flags.denied=0; flags.paused=false;
    log.length=0;
    pickBouncer();
    addLog("Night 1: Serbianhero arrives in a white suit outside Nachtarena.");
    renderHUD();
  }

  // =========================
  // Phaser game
  // =========================
  const W = 960, H = 540;
  const config = {
    type: Phaser.AUTO,
    canvas: document.getElementById("game"),
    width: W,
    height: H,
    backgroundColor: "#000000",
    physics: { default: "arcade", arcade: { gravity: { y: 0 }, debug: false } },
    pixelArt: false,
    scene: { preload, create, update }
  };

  let game, scene;
  let player, cursors, keys, uiText, siren;
  let npcs = [], bouncers = [], paparazzi = null;
  let walls, doorZones = {}, slideZone, tailorZone;
  let slapCooldown = 0, interactCooldown = 0;
  let stageBarrier = null;
  let floatingTexts;

  function preload(){
    // Procedural textures to avoid missing files.
    const g = this.make.graphics({ x:0, y:0, add:false });

    // Player frames: white suit + accent tie. Two-step walk frames and slap frame.
    function makePlayerTex(key, armOut){
      g.clear();
      // glow shadow
      g.fillStyle(0x000000, 0.55).fillEllipse(20, 32, 28, 10);
      // body suit
      g.fillStyle(0xf7f7fb, 1).fillRoundedRect(8, 10, 24, 24, 6);
      // lapel
      g.fillStyle(0xd8d8e6, 1).fillTriangle(8, 10, 20, 22, 32, 10);
      // tie
      g.fillStyle(0xff4d6d, 0.55).fillRoundedRect(18, 14, 4, 14, 2);
      // head
      g.fillStyle(0xf1c7a3, 1).fillCircle(20, 8, 7);
      // hair
      g.fillStyle(0x1b1b1b, 1).fillRoundedRect(13, 1, 14, 6, 3);
      // arms
      g.fillStyle(0xf7f7fb, 1);
      if(armOut){
        g.fillRoundedRect(30, 16, 10, 5, 2); // slap arm
        g.fillRoundedRect(0, 16, 10, 5, 2);
      } else {
        g.fillRoundedRect(30, 18, 7, 4, 2);
        g.fillRoundedRect(3, 18, 7, 4, 2);
      }
      // feet
      g.fillStyle(0x111111, 1).fillRoundedRect(10, 34, 8, 4, 2);
      g.fillRoundedRect(22, 34, 8, 4, 2);

      g.generateTexture(key, 40, 40);
    }

    makePlayerTex("p_walk1", false);
    makePlayerTex("p_walk2", false);
    makePlayerTex("p_slap", true);

    // NPC texture
    function makeNpcTex(key, color){
      g.clear();
      g.fillStyle(0x000000, 0.45).fillEllipse(18, 30, 26, 10);
      g.fillStyle(color, 1).fillRoundedRect(6, 10, 24, 22, 6);
      g.fillStyle(0xf1c7a3, 1).fillCircle(18, 8, 7);
      g.fillStyle(0x111111, 1).fillRoundedRect(8, 32, 8, 4, 2);
      g.fillRoundedRect(20, 32, 8, 4, 2);
      g.generateTexture(key, 36, 36);
    }
    makeNpcTex("npc_red", 0xe94560);
    makeNpcTex("npc_blue", 0x60a5fa);
    makeNpcTex("npc_green", 0x36d399);
    makeNpcTex("npc_purple", 0xa78bfa);

    // Bouncer texture
    function makeBouncerTex(key, color){
      g.clear();
      g.fillStyle(0x000000, 0.55).fillEllipse(22, 36, 34, 12);
      g.fillStyle(color, 1).fillRoundedRect(6, 12, 32, 24, 8);
      g.fillStyle(0xf1c7a3, 1).fillCircle(22, 10, 8);
      g.fillStyle(0x111111, 1).fillRoundedRect(10, 38, 10, 5, 2);
      g.fillRoundedRect(24, 38, 10, 5, 2);
      // armband
      g.fillStyle(0xffffff, 0.28).fillRoundedRect(6, 20, 6, 10, 3);
      g.generateTexture(key, 44, 44);
    }
    makeBouncerTex("bouncer", 0x222236);

    // Neon props
    function makeNeonRect(key, w, h, c1, c2){
      g.clear();
      g.lineStyle(6, c1, 0.25).strokeRoundedRect(3, 3, w-6, h-6, 14);
      g.lineStyle(2, c2, 0.95).strokeRoundedRect(5, 5, w-10, h-10, 12);
      g.generateTexture(key, w, h);
    }
    makeNeonRect("doorSign", 220, 70, 0xff4d6d, 0xffffff);
    makeNeonRect("slideSign", 180, 50, 0xfbbf24, 0xffffff);
    makeNeonRect("tailorSign", 170, 50, 0x36d399, 0xffffff);

    // Particles
    g.clear();
    g.fillStyle(0xffffff, 1).fillCircle(4,4,4);
    g.generateTexture("spark", 8, 8);
  }

  function create(){
    scene = this;
    floatingTexts = this.add.group();

    // Background street
    const bg = this.add.graphics();
    bg.fillStyle(0x070710, 1).fillRect(0,0,W,H);
    bg.fillStyle(0x0b0b18, 1).fillRect(0, 0, W, 140);
    bg.fillStyle(0x0a0a12, 1).fillRect(0, 140, W, H-140);

    // Neon puddles
    for(let i=0;i<26;i++){
      const x = Phaser.Math.Between(30, W-30);
      const y = Phaser.Math.Between(160, H-30);
      const c = Phaser.Utils.Array.GetRandom([0xff4d6d, 0x36d399, 0x60a5fa, 0xa78bfa, 0xfbbf24]);
      const a = Phaser.Math.FloatBetween(0.05, 0.16);
      bg.fillStyle(c, a).fillEllipse(x, y, Phaser.Math.Between(40, 110), Phaser.Math.Between(18, 55));
    }

    // Walls/colliders
    walls = this.physics.add.staticGroup();
    // outer border
    walls.add(this.add.rectangle(W/2, 6, W, 12, 0x000000, 0).setOrigin(0.5)).body.setSize(W,12).setOffset(-W/2,-6);
    walls.add(this.add.rectangle(W/2, H-6, W, 12, 0x000000, 0).setOrigin(0.5)).body.setSize(W,12).setOffset(-W/2,-6);
    walls.add(this.add.rectangle(6, H/2, 12, H, 0x000000, 0).setOrigin(0.5)).body.setSize(12,H).setOffset(-6,-H/2);
    walls.add(this.add.rectangle(W-6, H/2, 12, H, 0x000000, 0).setOrigin(0.5)).body.setSize(12,H).setOffset(-6,-H/2);

    // Club building block
    const clubBlock = this.add.rectangle(W/2, 82, 640, 150, 0x111125, 1);
    clubBlock.setStrokeStyle(2, 0xffffff, 0.08);
    walls.add(clubBlock);

    // Door opening area (a gap in wall collider for clubBlock is not trivial with rectangles),
    // so we keep the wall and use door zones in front of it.
    // Visual door
    const door = this.add.rectangle(W/2, 132, 140, 28, 0x0b0b10, 1);
    door.setStrokeStyle(2, 0xffffff, 0.12);

    // Neon sign
    const sign = this.add.image(W/2, 36, "doorSign").setAlpha(0.95);
    this.add.text(W/2, 38, "NACHTARENA", { fontFamily:"system-ui,Segoe UI,Arial", fontSize:"18px", color:"#ffffff" }).setOrigin(0.5);

    // Stage barrier (rope line)
    stageBarrier = this.add.rectangle(W/2, 172, 220, 12, 0xffffff, 0.08);
    stageBarrier.setStrokeStyle(2, 0xff4d6d, 0.35);
    this.physics.add.existing(stageBarrier, true);

    // Door zones: three checkpoints
    doorZones.stage0 = this.add.zone(W/2, 210, 260, 70);
    doorZones.stage1 = this.add.zone(W/2, 160, 200, 50);
    doorZones.stage2 = this.add.zone(W/2, 135, 150, 40);
    this.physics.add.existing(doorZones.stage0, true);
    this.physics.add.existing(doorZones.stage1, true);
    this.physics.add.existing(doorZones.stage2, true);

    // Slide (so-called "Gayrutsche" in the story, treated as a neon slide prop)
    const slideBase = this.add.rectangle(120, 120, 170, 120, 0x10101d, 1);
    slideBase.setStrokeStyle(2, 0xffffff, 0.08);
    const slideSign = this.add.image(120, 55, "slideSign").setAlpha(0.95);
    this.add.text(120, 56, "NEON SLIDE", { fontFamily:"system-ui,Segoe UI,Arial", fontSize:"14px", color:"#ffffff" }).setOrigin(0.5);

    slideZone = this.add.zone(120, 130, 190, 120);
    this.physics.add.existing(slideZone, true);

    // Tailor kiosk (repair suit)
    const tailorBase = this.add.rectangle(W-130, 160, 200, 110, 0x10101d, 1);
    tailorBase.setStrokeStyle(2, 0xffffff, 0.08);
    const tSign = this.add.image(W-130, 105, "tailorSign").setAlpha(0.95);
    this.add.text(W-130, 106, "TAILOR", { fontFamily:"system-ui,Segoe UI,Arial", fontSize:"14px", color:"#ffffff" }).setOrigin(0.5);

    tailorZone = this.add.zone(W-130, 160, 210, 120);
    this.physics.add.existing(tailorZone, true);

    // Paparazzi hotspot (viral)
    paparazzi = this.add.rectangle(W-250, H-90, 220, 120, 0x60a5fa, 0.05);
    paparazzi.setStrokeStyle(2, 0x60a5fa, 0.20);
    this.add.text(W-250, H-144, "PAPARAZZI", { fontFamily:"system-ui,Segoe UI,Arial", fontSize:"12px", color:"#b9d7ff" }).setOrigin(0.5);
    this.physics.add.existing(paparazzi, true);

    // Items on street
    const chain = this.add.rectangle(70, H-70, 18, 18, 0xfbbf24, 1).setStrokeStyle(1, 0xffffff, 0.18);
    chain.name = "Silver Chain";
    this.physics.add.existing(chain);
    chain.body.setCircle(9);

    const vip = this.add.rectangle(W-60, H-70, 18, 18, 0x36d399, 1).setStrokeStyle(1, 0xffffff, 0.18);
    vip.name = "VIP Card";
    this.physics.add.existing(vip);
    vip.body.setCircle(9);

    const pass = this.add.rectangle(W-70, 260, 18, 18, 0xff4d6d, 1).setStrokeStyle(1, 0xffffff, 0.18);
    pass.name = "Press Pass";
    this.physics.add.existing(pass);
    pass.body.setCircle(9);

    // Player
    player = this.physics.add.sprite(W/2, H-120, "p_walk1");
    player.setCollideWorldBounds(true);
    player.setDrag(500,500);
    player.setMaxVelocity(210,210);
    player.setDepth(5);

    this.anims.create({ key:"walk", frames:[{key:"p_walk1"},{key:"p_walk2"}], frameRate:8, repeat:-1 });
    this.anims.create({ key:"slap", frames:[{key:"p_slap"}], frameRate:14, repeat:0 });

    // NPC crowd
    const npcKeys = ["npc_red","npc_blue","npc_green","npc_purple"];
    for(let i=0;i<10;i++){
      const s = this.physics.add.sprite(Phaser.Math.Between(220, W-220), Phaser.Math.Between(210, H-140), Phaser.Utils.Array.GetRandom(npcKeys));
      s.setDepth(4);
      s.setCollideWorldBounds(true);
      s.body.setSize(26,26).setOffset(5,6);
      s._type = "crowd";
      s._hp = 1;
      s._panic = 0;
      npcs.push(s);
    }

    // Security / bouncers near door
    for(let i=0;i<3;i++){
      const b = this.physics.add.sprite(W/2 + (i-1)*70, 210, "bouncer");
      b.setDepth(6);
      b.setImmovable(true);
      b.body.setSize(34,34).setOffset(5,6);
      b._type = "security";
      b._hp = 3;
      bouncers.push(b);
    }

    // Colliders
    this.physics.add.collider(player, walls);
    this.physics.add.collider(player, stageBarrier);
    this.physics.add.collider(player, bouncers);
    this.physics.add.collider(npcs, walls);
    this.physics.add.collider(npcs, bouncers);

    // Overlap items
    this.physics.add.overlap(player, chain, () => pickup(chain), null, this);
    this.physics.add.overlap(player, vip, () => pickup(vip), null, this);
    this.physics.add.overlap(player, pass, () => pickup(pass), null, this);

    // Door overlaps
    this.physics.add.overlap(player, doorZones.stage0, () => doorAttempt(0), null, this);
    this.physics.add.overlap(player, doorZones.stage1, () => doorAttempt(1), null, this);
    this.physics.add.overlap(player, doorZones.stage2, () => doorAttempt(2), null, this);

    // Interact zones
    this.physics.add.overlap(player, slideZone, () => hint("Press E to use the neon slide (cool off fast)."), null, this);
    this.physics.add.overlap(player, tailorZone, () => hint("Press E to repair the suit (cost: 8 cash)."), null, this);

    // UI overlay (inside canvas)
    uiText = this.add.text(12, 12, "", { fontFamily:"system-ui,Segoe UI,Arial", fontSize:"14px", color:"#ffffff" }).setDepth(20);
    uiText.setShadow(0, 2, "#000000", 6, true, true);

    // Particles
    const particles = this.add.particles(0, 0, "spark", {
      speed: { min: 40, max: 220 },
      lifespan: { min: 140, max: 320 },
      scale: { start: 0.7, end: 0 },
      quantity: 0,
      emitting: false,
      blendMode: "ADD"
    });

    // Sound (optional, simple synth beep via WebAudio)
    siren = { playing:false };

    // Input
    cursors = this.input.keyboard.createCursorKeys();
    keys = this.input.keyboard.addKeys("W,A,S,D,E,SPACE,P");
    this.input.keyboard.on("keydown-P", () => togglePause());
    this.input.keyboard.on("keydown-SPACE", () => doSlap(particles));
    this.input.keyboard.on("keydown-E", () => doInteract());

    // Start run
    resetAll();
    addLog("Tip: build respect by talking calmly at the door, or earn viral at PAPARAZZI.");
  }

  function update(time, delta){
    if(flags.paused) { uiText.setText("PAUSED (press P)"); return; }

    // Cooldowns
    slapCooldown = Math.max(0, slapCooldown - delta);
    interactCooldown = Math.max(0, interactCooldown - delta);

    // Movement
    const speed = 190;
    let vx = 0, vy = 0;
    if(cursors.left.isDown || keys.A.isDown) vx -= speed;
    if(cursors.right.isDown || keys.D.isDown) vx += speed;
    if(cursors.up.isDown || keys.W.isDown) vy -= speed;
    if(cursors.down.isDown || keys.S.isDown) vy += speed;
    player.setVelocity(vx, vy);

    if(vx !== 0 || vy !== 0){
      if(!player.anims.isPlaying || player.anims.currentAnim.key !== "walk") player.play("walk", true);
      player.flipX = vx < 0;
      player._dir = { x: Math.sign(vx), y: Math.sign(vy) };
    } else {
      player.anims.stop();
      player.setTexture("p_walk1");
    }

    // NPC behavior: simple wander + panic
    for(const n of npcs){
      n._panic = Math.max(0, n._panic - delta);
      if(n._panic > 0){
        // run away from player
        const dx = n.x - player.x;
        const dy = n.y - player.y;
        const m = Math.max(1, Math.hypot(dx, dy));
        n.setVelocity((dx/m)*140, (dy/m)*140);
      } else if(Math.random() < 0.012){
        n.setVelocity(Phaser.Math.Between(-80, 80), Phaser.Math.Between(-80, 80));
      }
    }

    // Security behavior: hold line
    for(const b of bouncers){
      b.setVelocity(0,0);
    }

    // Escalation: heat
    if(stats.heat >= 90){
      endNight("POLICE LOCKDOWN", "Heat hit 90. Sirens, shutdown.");
    } else if(stats.energy <= 0){
      endNight("BURNOUT", "Energy hit 0. Serbianhero collapses on the curb.");
    }

    // UI text
    uiText.setText(`Stage ${flags.stage}/3 · Heat ${stats.heat} · Suit ${stats.suit} · Respect ${stats.respect} · Viral ${stats.viral}`);
  }

  function hint(msg){
    // Throttle hints so it does not spam.
    if(interactCooldown > 0) return;
    interactCooldown = 700;
    // only show as log sometimes
    if(Math.random() < 0.35) addLog(msg);
  }

  function floatText(x, y, text, color="#ffffff"){
    const t = scene.add.text(x, y, text, { fontFamily:"system-ui,Segoe UI,Arial", fontSize:"12px", color });
    t.setDepth(30);
    scene.tweens.add({
      targets: t,
      y: y - 24,
      alpha: 0,
      duration: 650,
      ease: "Sine.easeOut",
      onComplete: () => t.destroy()
    });
  }

  function pickup(obj){
    if(!obj.active) return;
    obj.active = false;
    obj.visible = false;
    inv[obj.name] = (inv[obj.name] || 0) + 1;
    addLog(`Picked up: ${obj.name}.`);
    if(obj.name === "Press Pass") applyDelta({ respect: 4, viral: 8 });
    if(obj.name === "Silver Chain") applyDelta({ swagger: 6 });
    if(obj.name === "VIP Card") applyDelta({ respect: 8, heat: -2 });
    floatText(player.x, player.y-18, `+ ${obj.name}`, "#fbbf24");
  }

  function doorAttempt(stageIdx){
    // Only handle when player is near the correct stage gate.
    if(stageIdx !== flags.stage) return;

    // Rope barrier blocks stage 0 until acceptance. Stages 1 and 2 are "virtual" checks.
    // On touch, do not auto-check every frame; only when pressing E.
    hint(`Door check at stage ${flags.stage}/3. Press E to talk.`);
  }

  function doorTalk(){
    const res = checkDoor();
    const b = res.bouncer;

    if(res.ok){
      flags.stage += 1;
      addLog(`${b.name} lets you pass stage ${flags.stage}/3.`);
      applyDelta({ respect: 5, swagger: 3, rage: -5 });
      floatText(player.x, player.y-18, `Stage +1`, "#36d399");

      // Stage barrier logic
      if(flags.stage >= 1){
        // disable rope barrier collider to allow approach
        stageBarrier.body.enable = false;
        stageBarrier.setAlpha(0.05);
      }
      if(flags.stage >= 3){
        enterClub();
      }
      renderHUD();
      return;
    }

    // Denied
    flags.denied += 1;
    applyDelta({ rage: 8, heat: 6, energy: -4 });
    addLog(`${b.name} denies entry: ${res.reasons.join(", ")}.`);
    addLog("Security gestures toward the neon slide to cool off.");
    floatText(player.x, player.y-18, "DENIED", "#ff4d6d");

    // If the player keeps getting denied, the crowd becomes a bit more hostile.
    if(flags.denied >= 2) applyDelta({ heat: 2 });

    renderHUD();
  }

  function enterClub(){
    addLog("The door opens. Bass hits. Serbianhero is inside Nachtarena.");
    applyDelta({ heat: 5, swagger: 10 });
    renderHUD();
    // Simple celebration: fireworks particles and then new night
    const burst = scene.add.particles(player.x, player.y, "spark", {
      speed: { min: 80, max: 320 },
      lifespan: { min: 240, max: 520 },
      scale: { start: 0.9, end: 0 },
      quantity: 80,
      blendMode: "ADD"
    });
    scene.time.delayedCall(650, () => burst.destroy());
    scene.time.delayedCall(1400, () => {
      addLog("Afterparty fades. New night begins.");
      nextNight();
    });
  }

  function nextNight(){
    flags.night += 1;
    flags.stage = 0;
    flags.denied = 0;
    pickBouncer();
    stageBarrier.body.enable = true;
    stageBarrier.setAlpha(1);
    player.setPosition(W/2, H-120);
    applyDelta({ heat: -10, rage: -8, energy: 12, suit: 3 });
    addLog(`Night ${flags.night}: Serbianhero returns to the door in the white suit.`);
    renderHUD();
  }

  function doSlap(particles){
    if(flags.paused) return;
    if(slapCooldown > 0) return;
    slapCooldown = 420;

    // Slap animation
    player.play("slap", true);
    scene.time.delayedCall(120, () => {
      if(!player.anims.isPlaying) player.setTexture("p_walk1");
    });

    // Slap arc in front
    const dirX = (player._dir && player._dir.x !== 0) ? player._dir.x : (player.flipX ? -1 : 1);
    const dirY = (player._dir && player._dir.y) ? player._dir.y : 0;
    const cx = player.x + dirX*26;
    const cy = player.y + dirY*8;

    particles.setPosition(cx, cy);
    particles.emitParticle(12);

    let hitSomething = false;

    // Hit crowd
    for(const n of npcs){
      const d = Phaser.Math.Distance.Between(cx, cy, n.x, n.y);
      if(d < 34){
        hitSomething = true;
        n._panic = 1300;
        const dx = n.x - player.x;
        const dy = n.y - player.y;
        const m = Math.max(1, Math.hypot(dx, dy));
        n.setVelocity((dx/m)*220, (dy/m)*220);
        floatText(n.x, n.y-20, "SLAP!", "#ff4d6d");
        applyDelta({ respect: 2, heat: 2, rage: 2 });
      }
    }

    // Hit security
    for(const b of bouncers){
      const d = Phaser.Math.Distance.Between(cx, cy, b.x, b.y);
      if(d < 40){
        hitSomething = true;
        b._hp -= 1;
        floatText(b.x, b.y-22, "SECURITY HIT", "#fbbf24");
        applyDelta({ heat: 6, rage: 4, respect: -2, suit: -2 });
        if(b._hp <= 0){
          // temporarily back off
          b.disableBody(true, true);
          addLog("A security guard backs off. The line shifts.");
          scene.time.delayedCall(2200, () => {
            b._hp = 3;
            b.enableBody(true, b.x, b.y, true, true);
          });
        }
      }
    }

    // Viral bonus if near paparazzi
    const nearP = Phaser.Geom.Rectangle.Contains(paparazzi.getBounds(), player.x, player.y);
    if(nearP && hitSomething){
      applyDelta({ viral: 6, cash: 3, heat: 2 });
      floatText(player.x, player.y-30, "+VIRAL", "#60a5fa");
      addLog("Paparazzi catches it. Viral goes up.");
    }

    if(hitSomething){
      stats.energy = clamp(stats.energy - 1, 0, MAX.energy);
      renderHUD();
    } else {
      // Whiff still raises heat a bit
      applyDelta({ heat: 1 });
    }
  }

  function doInteract(){
    if(flags.paused) return;
    if(interactCooldown > 0) return;
    interactCooldown = 250;

    // Door talk if close to door zones
    const nearDoor = (flags.stage === 0 && Phaser.Math.Distance.Between(player.x, player.y, W/2, 210) < 90) ||
                     (flags.stage === 1 && Phaser.Math.Distance.Between(player.x, player.y, W/2, 160) < 70) ||
                     (flags.stage === 2 && Phaser.Math.Distance.Between(player.x, player.y, W/2, 135) < 60);
    if(nearDoor){
      doorTalk();
      return;
    }

    // Slide use
    if(Phaser.Geom.Rectangle.Contains(slideZone.getBounds(), player.x, player.y)){
      useSlide();
      return;
    }

    // Tailor
    if(Phaser.Geom.Rectangle.Contains(tailorZone.getBounds(), player.x, player.y)){
      repairSuit();
      return;
    }

    addLog("Nothing to interact with here.");
  }

  function useSlide(){
    // "so-called 'Gayrutsche'" is treated as a neon slide prop (no slur usage intended)
    addLog("Serbianhero uses the neon slide to cool off fast.");
    applyDelta({ heat: -18, rage: -8, suit: -4, energy: 6 });
    floatText(player.x, player.y-22, "COOL OFF", "#36d399");

    // Slide motion: quick swoop down
    const startX = player.x, startY = player.y;
    const endX = 120, endY = 210;
    scene.tweens.add({
      targets: player,
      x: endX,
      y: endY,
      duration: 420,
      ease: "Sine.easeInOut",
      onStart: () => player.setTexture("p_walk2"),
      onComplete: () => player.setTexture("p_walk1")
    });
    renderHUD();
  }

  function repairSuit(){
    if(stats.cash < 8){
      addLog("Tailor: Not enough cash to repair the suit (need 8).");
      floatText(player.x, player.y-22, "NEED CASH", "#fbbf24");
      return;
    }
    addLog("Tailor repairs the white suit. Clean look restored.");
    applyDelta({ cash: -8, suit: 15, heat: -2, swagger: 2 });
    floatText(player.x, player.y-22, "+SUIT", "#36d399");
  }

  function togglePause(){
    flags.paused = !flags.paused;
    addLog(flags.paused ? "Paused." : "Unpaused.");
  }

  function endNight(title, reason){
    addLog(`${title}: ${reason}`);
    flags.paused = true;
    // Hard reset after a moment
    scene.time.delayedCall(1200, () => {
      flags.paused = false;
      nextNight();
    });
  }

  // =========================
  // UI buttons
  // =========================
  document.getElementById("btnReset").addEventListener("click", () => {
    resetAll();
    if(scene){
      // respawn items
      scene.children.list.forEach(o => {
        if(o && o.name && (o.name === "Silver Chain" || o.name === "VIP Card" || o.name === "Press Pass")){
          o.active = true; o.visible = true;
          if(o.body) o.body.enable = true;
        }
      });
    }
  });

  document.getElementById("btnMute").addEventListener("click", () => {
    flags.muted = !flags.muted;
    document.getElementById("btnMute").textContent = flags.muted ? "Unmute" : "Mute";
    addLog(flags.muted ? "Muted." : "Unmuted.");
  });

  // =========================
  // Start
  // =========================
  game = new Phaser.Game(config);

  </script>
</body>
</html>
