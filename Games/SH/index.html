<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crimson Corridor 2D: Serbianhero at Nachtarena</title>
  <meta name="description" content="2D top-down action mini-game. Walk, talk, slap, cool off on the slide, and try to get into Nachtarena." />
  <style>
    :root{
      --bg:#05050a;
      --panel: rgba(18,18,30,0.88);
      --panel2: rgba(10,10,20,0.78);
      --line: rgba(255,255,255,0.10);
      --text: #f7f7fb;
      --muted: rgba(247,247,251,0.72);
      --hot: #ff4d6d;
      --ok: #36d399;
      --warn: #fbbf24;
      --shadow: 0 18px 44px rgba(0,0,0,0.62);
      --r: 16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html, body{ height:100%; margin:0; background: radial-gradient(circle at top, #15152a, var(--bg) 60%); color: var(--text); font-family: var(--font); }
    .wrap{ max-width: 1180px; margin: 0 auto; padding: 16px 14px 24px; }
    .top{ display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; margin-bottom: 10px; flex-wrap:wrap; }
    .top h1{ margin:0; font-size: 18px; letter-spacing: 0.12em; text-transform: uppercase; }
    .top .sub{ color: var(--muted); font-size: 12px; margin-top: 6px; }
    .grid{ display:grid; grid-template-columns: 2.3fr 1fr; gap: 14px; align-items:start; }
    .card{ background: var(--panel); border: 1px solid var(--line); border-radius: var(--r); box-shadow: var(--shadow); overflow:hidden; }
    .card.pad{ padding: 12px 12px; }
    #game{ width:100%; aspect-ratio: 16/9; background: #05050a; display:block; touch-action: none; }
    .hud h2, .log h2{ margin:0 0 8px 0; font-size: 14px; letter-spacing: 0.04em; }
    .pill{ display:flex; align-items:center; justify-content:space-between; gap:10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.07); border-radius: 999px; padding: 7px 10px; font-size: 12px; margin: 7px 0; }
    .pill b{ font-size: 12px; }
    .pill .v{ font-variant-numeric: tabular-nums; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.06); }
    .pill .bar{ flex:1; height: 6px; margin: 0 8px; border-radius: 999px; background: rgba(255,255,255,0.08); overflow:hidden; }
    .pill .bar > span{ display:block; height:100%; border-radius: 999px; background: linear-gradient(90deg, #60a5fa, #a78bfa); }
    .row{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 10px; }
    .btn{ appearance:none; border:0; cursor:pointer; border-radius: 12px; padding: 10px 12px; font-weight: 800; color: #fff;
      background: linear-gradient(90deg, #e94560, #ff4d6d); box-shadow: 0 10px 26px rgba(233,69,96,0.28);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.alt{ background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10); box-shadow:none; font-weight:700; }
    .btn.good{ background: linear-gradient(90deg, #1dd1a1, #36d399); box-shadow: 0 10px 26px rgba(54,211,153,0.22); }
    .btn.warn{ background: linear-gradient(90deg, #f59e0b, #fbbf24); box-shadow: 0 10px 26px rgba(251,191,36,0.18); color:#0b0b10; }
    .note{ background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 10px 12px; font-size: 12px; color: var(--muted); line-height: 1.35; }
    .log .entry{ background: var(--panel2); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 9px 10px; margin-bottom: 8px; font-size: 12px; color: var(--text); line-height: 1.35; }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10); font-size: 12px; color: var(--muted); }
    .footer{ margin-top: 12px; color: var(--muted); font-size: 12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .mobile-controls{ position: relative; height: 0; }
    .mobile-pad{ position: absolute; bottom: 12px; left: 12px; width: 140px; height: 140px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); box-shadow: var(--shadow); display:none; }
    .mobile-stick{ position: absolute; left: 50%; top: 50%; width: 56px; height: 56px; margin-left: -28px; margin-top: -28px; border-radius: 50%; background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.2); }
    .mobile-actions{ position: absolute; bottom: 14px; right: 12px; display:flex; gap: 10px; flex-wrap:wrap; justify-content:flex-end; width: 220px; display:none; }
    .mobile-actions button{ border:0; border-radius: 999px; padding: 12px 16px; font-weight: 800; color:#fff; background: linear-gradient(90deg, #60a5fa, #a78bfa); box-shadow: 0 10px 24px rgba(96,165,250,0.24); }
    .mobile-actions button.slap{ background: linear-gradient(90deg, #ff4d6d, #e94560); }
    .mobile-actions button.interact{ background: linear-gradient(90deg, #36d399, #1dd1a1); }
    .mobile-actions button.pause{ background: linear-gradient(90deg, #fbbf24, #f59e0b); color:#0b0b10; }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .btn{ width:100%; }
    }
    @media (max-width: 800px){
      .mobile-pad, .mobile-actions{ display:flex; }
      .mobile-controls{ height: 170px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Crimson Corridor 2D: Serbianhero at Nachtarena</h1>
        <div class="sub">Move, interact, slap (cartoon), cool off on the neon slide, and beat the door.</div>
      </div>
      <div class="badge" id="badge">Night 1 路 Stage 0/3</div>
    </div>

    <div class="grid">
      <div class="card" style="position:relative">
        <canvas id="game" width="960" height="540"></canvas>
        <div class="mobile-controls">
          <div class="mobile-pad" id="mobilePad">
            <div class="mobile-stick" id="mobileStick"></div>
          </div>
          <div class="mobile-actions">
            <button class="slap" id="btnSlap">SLAP</button>
            <button class="interact" id="btnInteract">INTERACT</button>
            <button class="pause" id="btnPause">PAUSE</button>
          </div>
        </div>
      </div>

      <div>
        <div class="card pad hud">
          <h2>HUD</h2>
          <div id="hud"></div>
          <div class="row">
            <button class="btn alt" id="btnReset">Reset</button>
            <button class="btn alt" id="btnMute">Mute</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card pad log">
          <h2>Feed</h2>
          <div id="log"></div>
          <div class="note" style="margin-top:10px">
            <b>Controls</b><br/>
            Move: WASD / Arrow keys / Touch pad<br/>
            Interact: E<br/>
            Slap (cartoon): Space<br/>
            Pause: P<br/><br/>
            <b>Mobile</b>: use the left pad + action buttons.<br/><br/>
            <b>Do-nots</b>: no gore, no slurs, no personal data, no ads/analytics, no monetization.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Runs fully in the browser. Static file. No tracking.</div>
      <div>Note: This is 2D, not GTA-level 3D.</div>
    </div>
  </div>

  <script>
  const MAX = { swagger:100, respect:100, energy:100, cash:100, heat:100, suit:100, rage:100, viral:100 };
  const stats = { swagger:45, respect:35, energy:55, cash:40, heat:10, suit:80, rage:20, viral:5 };
  const inv = { "VIP Card": 0, "Silver Chain": 0, "Press Pass": 0 };
  const flags = { stage:0, night:1, denied:0, paused:false, muted:false };
  const log = [];

  const BOUNCERS = {
    iron_wall: {
      name: "Miro 'Iron Wall'",
      checks: { min_suit: 75, min_respect: 45, min_viral: null, max_heat: 35, requires_item: null },
      tip: "He responds best to calm energy and low heat."
    },
    club_historian: {
      name: "Lana 'Records'",
      checks: { min_suit: 60, min_respect: 35, min_viral: 10, max_heat: 55, requires_item: "Silver Chain" },
      tip: "Bring the chain. Tell a heroic story. Be at least a little viral."
    },
    flash: {
      name: "Viktor 'Flash'",
      checks: { min_suit: 55, min_respect: 30, min_viral: 25, max_heat: 28, requires_item: null },
      tip: "He wants a moment that looks good on camera."
    },
    night_warden: {
      name: "Nebojsa 'Warden'",
      checks: { min_suit: 50, min_respect: 55, min_viral: null, max_heat: 22, requires_item: "VIP Card" },
      tip: "Heat-sensitive. VIP card helps."
    },
    heartbeat: {
      name: "Ana 'Heartbeat'",
      checks: { min_suit: 45, min_respect: 40, min_viral: null, max_heat: 50, requires_item: null },
      tip: "Empathy helps. Keep rage in check."
    }
  };

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const W = 960;
  const H = 540;
  const scale = { x: 1, y: 1 };

  const keys = new Set();
  const effects = [];
  const particles = [];
  let slapTimer = 0;
  let slapCooldown = 0;
  let lastInteractionHint = 0;
  const touchState = { active: false, id: null, startX: 0, startY: 0, dx: 0, dy: 0 };

  const player = { x: W/2, y: H-120, vx:0, vy:0, w:26, h:30, dir:{x:1,y:0} };
  const npcs = [];
  const bouncers = [];
  const items = [];

  const zones = {
    door0: { x: W/2, y: 210, w: 260, h: 70 },
    door1: { x: W/2, y: 160, w: 200, h: 50 },
    door2: { x: W/2, y: 135, w: 150, h: 40 },
    slide: { x: 120, y: 130, w: 190, h: 120 },
    tailor: { x: W-130, y: 160, w: 210, h: 120 },
    paparazzi: { x: W-250, y: H-90, w: 220, h: 120 }
  };

  const walls = [
    { x: W/2, y: 6, w: W, h: 12 },
    { x: W/2, y: H-6, w: W, h: 12 },
    { x: 6, y: H/2, w: 12, h: H },
    { x: W-6, y: H/2, w: 12, h: H },
    { x: W/2, y: 82, w: 640, h: 150 }
  ];

  const stageBarrier = { x: W/2, y: 172, w: 220, h: 12, active: true };

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function rnd(min, max){ return Math.random() * (max-min) + min; }

  function addLog(s){ log.push(s); renderLog(); }
  function applyDelta(d){
    for(const [k, ch] of Object.entries(d||{})){
      if(stats[k] !== undefined) stats[k] = clamp(stats[k] + ch, 0, MAX[k]);
    }
    renderHUD();
  }

  function pickBouncer(){
    const keys = Object.keys(BOUNCERS);
    flags.bouncer = keys[Math.floor(Math.random()*keys.length)];
  }

  function checkDoor(){
    const b = BOUNCERS[flags.bouncer];
    const c = b.checks;
    const reasons = [];
    if(stats.suit < c.min_suit) reasons.push("Suit too scuffed");
    if(stats.respect < c.min_respect) reasons.push("Not enough respect");
    if(c.min_viral !== null && stats.viral < c.min_viral) reasons.push("Not viral enough");
    if(c.max_heat !== null && stats.heat > c.max_heat) reasons.push("Heat too high");
    if(c.requires_item && (inv[c.requires_item]||0) <= 0) reasons.push("Missing required item");
    return { ok: reasons.length === 0, reasons, bouncer:b };
  }

  function updateBadge(){
    const el = document.getElementById("badge");
    el.textContent = `Night ${flags.night} 路 Stage ${flags.stage}/3`;
  }

  function renderHUD(){
    const hud = document.getElementById("hud");
    function pill(k, v){
      const pct = clamp(Math.round((v / MAX[k.toLowerCase()]) * 100), 0, 100);
      return `<div class="pill"><b>${k}</b><div class="bar"><span style="width:${pct}%"></span></div><span class="v">${v}</span></div>`;
    }
    hud.innerHTML = [
      pill("Swagger", stats.swagger),
      pill("Respect", stats.respect),
      pill("Energy", stats.energy),
      pill("Heat", stats.heat),
      pill("Suit", stats.suit),
      pill("Rage", stats.rage),
      pill("Viral", stats.viral),
      `<div class="note"><b>Bouncer:</b> ${BOUNCERS[flags.bouncer].name}<br/><span style="opacity:.85">${BOUNCERS[flags.bouncer].tip}</span></div>`,
      `<div class="note"><b>Inventory</b><br/>VIP Card: ${inv["VIP Card"]||0} 路 Silver Chain: ${inv["Silver Chain"]||0} 路 Press Pass: ${inv["Press Pass"]||0}</div>`
    ].join("");
    updateBadge();
  }

  function renderLog(){
    const el = document.getElementById("log");
    const last = log.slice(-7).reverse();
    el.innerHTML = last.map(x => `<div class="entry">${escapeHTML(x)}</div>`).join("");
  }

  function escapeHTML(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function resetAll(){
    stats.swagger=45; stats.respect=35; stats.energy=55; stats.cash=40;
    stats.heat=10; stats.suit=80; stats.rage=20; stats.viral=5;
    inv["VIP Card"]=0; inv["Silver Chain"]=0; inv["Press Pass"]=0;
    flags.stage=0; flags.night=1; flags.denied=0; flags.paused=false;
    log.length=0;
    pickBouncer();
    addLog("Night 1: Serbianhero arrives in a white suit outside Nachtarena.");
    renderHUD();
    resetEntities();
  }

  function resetEntities(){
    player.x = W/2;
    player.y = H-120;
    player.vx = 0;
    player.vy = 0;
    npcs.length = 0;
    bouncers.length = 0;
    items.length = 0;
    stageBarrier.active = true;

    for(let i=0;i<10;i++){
      npcs.push({
        x: rnd(220, W-220),
        y: rnd(210, H-140),
        vx: rnd(-50, 50),
        vy: rnd(-50, 50),
        panic: 0,
        color: ["#e94560", "#60a5fa", "#36d399", "#a78bfa"][Math.floor(Math.random()*4)]
      });
    }

    for(let i=0;i<3;i++){
      bouncers.push({ x: W/2 + (i-1)*70, y: 210, hp: 3 });
    }

    items.push({ name:"Silver Chain", x:70, y:H-70, color:"#fbbf24", active:true });
    items.push({ name:"VIP Card", x:W-60, y:H-70, color:"#36d399", active:true });
    items.push({ name:"Press Pass", x:W-70, y:260, color:"#ff4d6d", active:true });
  }

  function doorTalk(){
    const res = checkDoor();
    const b = res.bouncer;

    if(res.ok){
      flags.stage += 1;
      addLog(`${b.name} lets you pass stage ${flags.stage}/3.`);
      applyDelta({ respect: 5, swagger: 3, rage: -5 });
      effects.push({ text: "Stage +1", x: player.x, y: player.y-18, color: "#36d399", t: 0 });
      if(flags.stage >= 1){
        stageBarrier.active = false;
      }
      if(flags.stage >= 3){
        enterClub();
      }
      renderHUD();
      return;
    }

    flags.denied += 1;
    applyDelta({ rage: 8, heat: 6, energy: -4 });
    addLog(`${b.name} denies entry: ${res.reasons.join(", ")}.`);
    addLog("Security gestures toward the neon slide to cool off.");
    effects.push({ text: "DENIED", x: player.x, y: player.y-18, color: "#ff4d6d", t: 0 });
    if(flags.denied >= 2) applyDelta({ heat: 2 });
    renderHUD();
  }

  function enterClub(){
    addLog("The door opens. Bass hits. Serbianhero is inside Nachtarena.");
    applyDelta({ heat: 5, swagger: 10 });
    for(let i=0;i<80;i++){
      particles.push({ x: player.x, y: player.y, vx: rnd(-160, 160), vy: rnd(-180, 180), life: 0, max: rnd(0.4, 0.9), color: "#ffffff" });
    }
    setTimeout(() => {
      addLog("Afterparty fades. New night begins.");
      nextNight();
    }, 1200);
  }

  function nextNight(){
    flags.night += 1;
    flags.stage = 0;
    flags.denied = 0;
    pickBouncer();
    stageBarrier.active = true;
    player.x = W/2;
    player.y = H-120;
    applyDelta({ heat: -10, rage: -8, energy: 12, suit: 3 });
    addLog(`Night ${flags.night}: Serbianhero returns to the door in the white suit.`);
    renderHUD();
  }

  function useSlide(){
    addLog("Serbianhero uses the Gayrutsche (neon slide) to cool off fast.");
    applyDelta({ heat: -18, rage: -8, suit: -4, energy: 6 });
    effects.push({ text: "COOL OFF", x: player.x, y: player.y-22, color: "#36d399", t: 0 });
    player.x = 120;
    player.y = 210;
    for(let i=0;i<18;i++){
      particles.push({ x: player.x, y: player.y, vx: rnd(-60, 60), vy: rnd(-120, -20), life: 0, max: rnd(0.3, 0.6), color: "#36d399" });
    }
    renderHUD();
  }

  function repairSuit(){
    if(stats.cash < 8){
      addLog("Tailor: Not enough cash to repair the suit (need 8)." );
      effects.push({ text: "NEED CASH", x: player.x, y: player.y-22, color: "#fbbf24", t: 0 });
      return;
    }
    addLog("Tailor repairs the white suit. Clean look restored.");
    applyDelta({ cash: -8, suit: 15, heat: -2, swagger: 2 });
    effects.push({ text: "+SUIT", x: player.x, y: player.y-22, color: "#36d399", t: 0 });
  }

  function togglePause(){
    flags.paused = !flags.paused;
    addLog(flags.paused ? "Paused." : "Unpaused.");
  }

  function endNight(title, reason){
    addLog(`${title}: ${reason}`);
    flags.paused = true;
    setTimeout(() => {
      flags.paused = false;
      nextNight();
    }, 1200);
  }

  function isInside(zone, x, y){
    return Math.abs(x - zone.x) <= zone.w/2 && Math.abs(y - zone.y) <= zone.h/2;
  }

  function rectsOverlap(a, b){
    return Math.abs(a.x - b.x) < (a.w + b.w)/2 && Math.abs(a.y - b.y) < (a.h + b.h)/2;
  }

  function constrainToWalls(entity){
    for(const wall of walls){
      const overlap = rectsOverlap({ x: entity.x, y: entity.y, w: entity.w, h: entity.h }, wall);
      if(overlap){
        const dx = entity.x - wall.x;
        const dy = entity.y - wall.y;
        const px = (wall.w/2 + entity.w/2) - Math.abs(dx);
        const py = (wall.h/2 + entity.h/2) - Math.abs(dy);
        if(px < py){
          entity.x += dx > 0 ? px : -px;
          entity.vx = 0;
        } else {
          entity.y += dy > 0 ? py : -py;
          entity.vy = 0;
        }
      }
    }
    if(stageBarrier.active){
      const barrier = { x: stageBarrier.x, y: stageBarrier.y, w: stageBarrier.w, h: stageBarrier.h };
      const overlap = rectsOverlap({ x: entity.x, y: entity.y, w: entity.w, h: entity.h }, barrier);
      if(overlap){
        const dy = entity.y - barrier.y;
        const py = (barrier.h/2 + entity.h/2) - Math.abs(dy);
        entity.y += dy > 0 ? py : -py;
        entity.vy = 0;
      }
    }
  }

  function update(dt){
    if(flags.paused){
      return;
    }

    slapTimer = Math.max(0, slapTimer - dt);
    slapCooldown = Math.max(0, slapCooldown - dt);
    lastInteractionHint = Math.max(0, lastInteractionHint - dt);

    const accel = 900;
    const maxSpeed = 190;
    let ax = 0;
    let ay = 0;
    if(keys.has("ArrowLeft") || keys.has("a")) ax -= accel;
    if(keys.has("ArrowRight") || keys.has("d")) ax += accel;
    if(keys.has("ArrowUp") || keys.has("w")) ay -= accel;
    if(keys.has("ArrowDown") || keys.has("s")) ay += accel;

    ax += touchState.dx * accel;
    ay += touchState.dy * accel;

    player.vx = clamp(player.vx + ax * dt, -maxSpeed, maxSpeed);
    player.vy = clamp(player.vy + ay * dt, -maxSpeed, maxSpeed);

    if(Math.abs(ax) < 10) player.vx *= 0.85;
    if(Math.abs(ay) < 10) player.vy *= 0.85;

    player.x += player.vx * dt;
    player.y += player.vy * dt;

    if(player.vx !== 0 || player.vy !== 0){
      player.dir = { x: Math.sign(player.vx), y: Math.sign(player.vy) };
      if(Math.random() < 0.2){
        particles.push({ x: player.x, y: player.y+10, vx: rnd(-20,20), vy: rnd(10, 40), life: 0, max: rnd(0.2, 0.4), color: "#60a5fa" });
      }
    }

    constrainToWalls(player);
    maybeShowHints();

    for(const npc of npcs){
      npc.panic = Math.max(0, npc.panic - dt);
      if(npc.panic > 0){
        const dx = npc.x - player.x;
        const dy = npc.y - player.y;
        const m = Math.max(1, Math.hypot(dx, dy));
        npc.vx = (dx/m) * 120;
        npc.vy = (dy/m) * 120;
      } else if(Math.random() < 0.02){
        npc.vx = rnd(-60, 60);
        npc.vy = rnd(-60, 60);
      }

      npc.x += npc.vx * dt;
      npc.y += npc.vy * dt;
      npc.x = clamp(npc.x, 40, W-40);
      npc.y = clamp(npc.y, 160, H-40);
    }

    for(const item of items){
      if(!item.active) continue;
      const d = Math.hypot(player.x - item.x, player.y - item.y);
      if(d < 24){
        item.active = false;
        inv[item.name] = (inv[item.name] || 0) + 1;
        addLog(`Picked up: ${item.name}.`);
        if(item.name === "Press Pass") applyDelta({ respect: 4, viral: 8 });
        if(item.name === "Silver Chain") applyDelta({ swagger: 6 });
        if(item.name === "VIP Card") applyDelta({ respect: 8, heat: -2 });
        effects.push({ text: `+ ${item.name}`, x: player.x, y: player.y-18, color: "#fbbf24", t: 0 });
      }
    }

    for(const fx of effects){
      fx.t += dt;
    }

    for(const p of particles){
      p.life += dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
    }

    while(effects.length && effects[0].t > 0.9){
      effects.shift();
    }

    while(particles.length && particles[0].life > particles[0].max){
      particles.shift();
    }

    if(stats.heat >= 90){
      endNight("POLICE LOCKDOWN", "Heat hit 90. Sirens, shutdown.");
    } else if(stats.energy <= 0){
      endNight("BURNOUT", "Energy hit 0. Serbianhero collapses on the curb.");
    }
  }

  function draw(){
    ctx.clearRect(0, 0, W, H);

    const grd = ctx.createLinearGradient(0, 0, 0, H);
    grd.addColorStop(0, "#0a0a1b");
    grd.addColorStop(1, "#05050a");
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle = "rgba(255,255,255,0.04)";
    ctx.fillRect(0, 0, W, 140);

    for(let i=0;i<18;i++){
      ctx.fillStyle = ["rgba(255,77,109,0.10)", "rgba(54,211,153,0.10)", "rgba(96,165,250,0.10)", "rgba(167,139,250,0.10)", "rgba(251,191,36,0.10)"][i%5];
      ctx.beginPath();
      ctx.ellipse((i*50)%W, 200 + (i*23)%260, 60, 24, 0, 0, Math.PI*2);
      ctx.fill();
    }

    ctx.fillStyle = "#111125";
    ctx.fillRect(W/2-320, 7, 640, 150);
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.strokeRect(W/2-320, 7, 640, 150);

    ctx.fillStyle = "#0b0b10";
    ctx.fillRect(W/2-70, 118, 140, 28);
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.strokeRect(W/2-70, 118, 140, 28);

    drawNeonSign(W/2, 36, 220, 70, "NACHTARENA", "#ff4d6d");
    drawNeonSign(120, 55, 180, 50, "GAYRUTSCHE", "#fbbf24");
    drawNeonSign(W-130, 105, 170, 50, "TAILOR", "#36d399");

    ctx.fillStyle = "rgba(96,165,250,0.1)";
    ctx.fillRect(zones.paparazzi.x - zones.paparazzi.w/2, zones.paparazzi.y - zones.paparazzi.h/2, zones.paparazzi.w, zones.paparazzi.h);

    if(stageBarrier.active){
      ctx.strokeStyle = "rgba(255,77,109,0.4)";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(stageBarrier.x - stageBarrier.w/2, stageBarrier.y);
      ctx.lineTo(stageBarrier.x + stageBarrier.w/2, stageBarrier.y);
      ctx.stroke();
    }

    for(const item of items){
      if(!item.active) continue;
      ctx.fillStyle = item.color;
      ctx.beginPath();
      ctx.arc(item.x, item.y, 9, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.stroke();
    }

    for(const b of bouncers){
      drawBouncer(b.x, b.y);
    }

    for(const npc of npcs){
      drawNpc(npc.x, npc.y, npc.color);
    }

    drawPlayer(player.x, player.y);

    for(const fx of effects){
      const alpha = 1 - fx.t;
      ctx.fillStyle = hexToRgba(fx.color, alpha);
      ctx.font = "12px system-ui";
      ctx.fillText(fx.text, fx.x - 10, fx.y - fx.t * 20);
    }

    for(const p of particles){
      const alpha = 1 - p.life / p.max;
      ctx.fillStyle = hexToRgba(p.color, alpha);
      ctx.beginPath();
      ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
      ctx.fill();
    }

    drawLighting();

    if(flags.paused){
      ctx.fillStyle = "rgba(5,5,10,0.65)";
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = "#ffffff";
      ctx.font = "bold 20px system-ui";
      ctx.fillText("PAUSED (press P)", W/2 - 90, H/2);
    }
  }

  function drawNeonSign(x, y, w, h, text, color){
    ctx.strokeStyle = hexToRgba(color, 0.3);
    ctx.lineWidth = 6;
    ctx.strokeRect(x - w/2, y - h/2, w, h);
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.lineWidth = 2;
    ctx.strokeRect(x - w/2 + 2, y - h/2 + 2, w - 4, h - 4);
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 16px system-ui";
    ctx.fillText(text, x - ctx.measureText(text).width/2, y + 6);
  }

  function drawPlayer(x, y){
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.beginPath();
    ctx.ellipse(x, y+16, 14, 6, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "#f7f7fb";
    ctx.fillRect(x-10, y-6, 20, 20);
    ctx.fillStyle = "#d8d8e6";
    ctx.beginPath();
    ctx.moveTo(x-10, y-6);
    ctx.lineTo(x, y+8);
    ctx.lineTo(x+10, y-6);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "rgba(255,77,109,0.6)";
    ctx.fillRect(x-1, y-2, 2, 12);

    ctx.fillStyle = "#f1c7a3";
    ctx.beginPath();
    ctx.arc(x, y-14, 7, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#1b1b1b";
    ctx.fillRect(x-7, y-20, 14, 6);

    ctx.fillStyle = "#111111";
    ctx.fillRect(x-8, y+16, 6, 3);
    ctx.fillRect(x+2, y+16, 6, 3);

    if(slapTimer > 0){
      const dirX = player.dir.x || 1;
      const dirY = player.dir.y || 0;
      const armLength = 18 + (slapTimer * 40);
      const handX = x + dirX * armLength;
      const handY = y + dirY * 6;
      ctx.strokeStyle = "#f7f7fb";
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(x + dirX * 8, y + 2);
      ctx.lineTo(handX, handY);
      ctx.stroke();
      ctx.fillStyle = "#f1c7a3";
      ctx.beginPath();
      ctx.arc(handX, handY, 6, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "rgba(255,77,109,0.6)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(handX, handY, 10, 0, Math.PI*2);
      ctx.stroke();
    }
  }

  function drawNpc(x, y, color){
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.beginPath();
    ctx.ellipse(x, y+14, 12, 5, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = color;
    ctx.fillRect(x-10, y-6, 20, 18);
    ctx.fillStyle = "#f1c7a3";
    ctx.beginPath();
    ctx.arc(x, y-12, 6, 0, Math.PI*2);
    ctx.fill();
  }

  function drawBouncer(x, y){
    ctx.fillStyle = "rgba(0,0,0,0.45)";
    ctx.beginPath();
    ctx.ellipse(x, y+18, 16, 6, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#222236";
    ctx.fillRect(x-14, y-6, 28, 20);
    ctx.fillStyle = "#f1c7a3";
    ctx.beginPath();
    ctx.arc(x, y-12, 7, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.25)";
    ctx.fillRect(x-14, y-2, 6, 10);
  }

  function drawLighting(){
    const gradient = ctx.createRadialGradient(player.x, player.y, 20, player.x, player.y, 150);
    gradient.addColorStop(0, "rgba(255,255,255,0.1)");
    gradient.addColorStop(1, "rgba(5,5,10,0.7)");
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, W, H);
  }

  function hexToRgba(hex, a){
    const h = hex.replace("#", "");
    const r = parseInt(h.substring(0,2), 16);
    const g = parseInt(h.substring(2,4), 16);
    const b = parseInt(h.substring(4,6), 16);
    return `rgba(${r},${g},${b},${a})`;
  }

  function checkInteraction(){
    if(isInside(zones.slide, player.x, player.y)){
      addLog("Press E to use the Gayrutsche (cool off fast).");
      return "slide";
    }
    if(isInside(zones.tailor, player.x, player.y)){
      addLog("Press E to repair the suit (cost: 8 cash).");
      return "tailor";
    }
    if(flags.stage === 0 && isInside(zones.door0, player.x, player.y)){
      addLog("Door check at stage 0/3. Press E to talk.");
      return "door";
    }
    if(flags.stage === 1 && isInside(zones.door1, player.x, player.y)){
      addLog("Door check at stage 1/3. Press E to talk.");
      return "door";
    }
    if(flags.stage === 2 && isInside(zones.door2, player.x, player.y)){
      addLog("Door check at stage 2/3. Press E to talk.");
      return "door";
    }
    return null;
  }

  function doSlap(){
    if(slapCooldown > 0) return;
    slapCooldown = 0.35;
    slapTimer = 0.22;
    const dirX = player.dir.x || 1;
    const dirY = player.dir.y || 0;
    const cx = player.x + dirX * 26;
    const cy = player.y + dirY * 8;
    let hitSomething = false;

    for(const npc of npcs){
      const d = Math.hypot(cx - npc.x, cy - npc.y);
      if(d < 34){
        hitSomething = true;
        npc.panic = 0.9;
        const dx = npc.x - player.x;
        const dy = npc.y - player.y;
        const m = Math.max(1, Math.hypot(dx, dy));
        npc.vx = (dx/m) * 160;
        npc.vy = (dy/m) * 160;
        effects.push({ text: "SLAP!", x: npc.x, y: npc.y-18, color: "#ff4d6d", t: 0 });
        applyDelta({ respect: 2, heat: 2, rage: 2 });
      }
    }

    for(const b of bouncers){
      const d = Math.hypot(cx - b.x, cy - b.y);
      if(d < 40){
        hitSomething = true;
        b.hp -= 1;
        effects.push({ text: "SECURITY HIT", x: b.x, y: b.y-22, color: "#fbbf24", t: 0 });
        applyDelta({ heat: 6, rage: 4, respect: -2, suit: -2 });
        if(b.hp <= 0){
          b.x += rnd(-60, 60);
          b.hp = 3;
        }
      }
    }

    if(isInside(zones.paparazzi, player.x, player.y) && hitSomething){
      applyDelta({ viral: 6, cash: 3, heat: 2 });
      effects.push({ text: "+VIRAL", x: player.x, y: player.y-30, color: "#60a5fa", t: 0 });
      addLog("Paparazzi catches it. Viral goes up.");
    }

    for(let i=0;i<20;i++){
      particles.push({ x: cx, y: cy, vx: rnd(-140, 140), vy: rnd(-140, 140), life: 0, max: rnd(0.2, 0.6), color: "#ff4d6d" });
    }

    if(hitSomething){
      stats.energy = clamp(stats.energy - 1, 0, MAX.energy);
      renderHUD();
    } else {
      applyDelta({ heat: 1 });
    }
  }

  let lastTime = 0;
  function loop(ts){
    const dt = Math.min(0.032, (ts - lastTime) / 1000 || 0.016);
    lastTime = ts;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const ratio = rect.width / W;
    scale.x = ratio;
    scale.y = ratio;
    canvas.style.height = `${H * ratio}px`;
  }

  window.addEventListener("resize", resizeCanvas);

  window.addEventListener("keydown", (e) => {
    if(["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)){
      e.preventDefault();
    }
    keys.add(e.key.toLowerCase());
    if(e.key.toLowerCase() === "p") togglePause();
    if(e.key === " ") doSlap();
    if(e.key.toLowerCase() === "e"){
      const interaction = checkInteraction();
      if(interaction === "slide") useSlide();
      if(interaction === "tailor") repairSuit();
      if(interaction === "door") doorTalk();
    }
  });

  window.addEventListener("keyup", (e) => {
    keys.delete(e.key.toLowerCase());
  });

  function handleTouchStart(e){
    e.preventDefault();
    if(touchState.active) return;
    const touch = e.changedTouches[0];
    const pad = document.getElementById("mobilePad").getBoundingClientRect();
    if(touch.clientX < pad.right && touch.clientY > pad.top){
      touchState.active = true;
      touchState.id = touch.identifier;
      touchState.startX = touch.clientX;
      touchState.startY = touch.clientY;
      touchState.dx = 0;
      touchState.dy = 0;
      updateStick(0, 0);
    }
  }

  function handleTouchMove(e){
    e.preventDefault();
    if(!touchState.active) return;
    const touch = Array.from(e.changedTouches).find(t => t.identifier === touchState.id);
    if(!touch) return;
    const dx = touch.clientX - touchState.startX;
    const dy = touch.clientY - touchState.startY;
    const max = 40;
    const dist = Math.hypot(dx, dy);
    const scale = dist > max ? max / dist : 1;
    const ndx = (dx * scale) / max;
    const ndy = (dy * scale) / max;
    touchState.dx = ndx;
    touchState.dy = ndy;
    updateStick(dx * scale, dy * scale);
  }

  function handleTouchEnd(e){
    e.preventDefault();
    const touch = Array.from(e.changedTouches).find(t => t.identifier === touchState.id);
    if(!touch) return;
    touchState.active = false;
    touchState.id = null;
    touchState.dx = 0;
    touchState.dy = 0;
    updateStick(0, 0);
  }

  function updateStick(dx, dy){
    const stick = document.getElementById("mobileStick");
    stick.style.transform = `translate(${dx}px, ${dy}px)`;
  }

  function maybeShowHints(){
    if(lastInteractionHint > 0) return;
    if(isInside(zones.slide, player.x, player.y)){
      addLog("Tap INTERACT to use the Gayrutsche.");
      lastInteractionHint = 1.2;
    } else if(isInside(zones.tailor, player.x, player.y)){
      addLog("Tap INTERACT to repair the suit.");
      lastInteractionHint = 1.2;
    } else if(isInside(zones.door0, player.x, player.y) || isInside(zones.door1, player.x, player.y) || isInside(zones.door2, player.x, player.y)){
      addLog("Tap INTERACT to talk to the bouncer.");
      lastInteractionHint = 1.2;
    }
  }

  document.getElementById("btnReset").addEventListener("click", () => {
    resetAll();
  });

  document.getElementById("btnMute").addEventListener("click", () => {
    flags.muted = !flags.muted;
    document.getElementById("btnMute").textContent = flags.muted ? "Unmute" : "Mute";
    addLog(flags.muted ? "Muted." : "Unmuted.");
  });

  document.getElementById("btnSlap").addEventListener("click", () => {
    doSlap();
  });

  document.getElementById("btnInteract").addEventListener("click", () => {
    const interaction = checkInteraction();
    if(interaction === "slide") useSlide();
    if(interaction === "tailor") repairSuit();
    if(interaction === "door") doorTalk();
  });

  document.getElementById("btnPause").addEventListener("click", () => {
    togglePause();
  });

  canvas.addEventListener("touchstart", handleTouchStart, { passive: false });
  canvas.addEventListener("touchmove", handleTouchMove, { passive: false });
  canvas.addEventListener("touchend", handleTouchEnd);
  canvas.addEventListener("touchcancel", handleTouchEnd);

  resizeCanvas();
  pickBouncer();
  renderHUD();
  addLog("Tip: build respect by talking calmly at the door, or earn viral at PAPARAZZI.");
  requestAnimationFrame(loop);
  </script>
</body>
</html>
